<!DOCTYPE html>
<html lang="zh">
    <head>
    <!-- 
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.0 -->

    <!-- Title -->
    
    <title>
        
            Android 7.0 行为变更之FileProvider | 
        
        lennyup&#39;s Notes
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!-- Meta & Info -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="lennyup">
    <meta name="description" content="不得了">
    <meta name="keywords" content="“不得了”">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="lennyup&#39;s Notes">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="https://lennyup.github.io">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="Android 7.0 行为变更之FileProvider | lennyup&#39;s Notes">
    <meta property="og:description" content="不得了">
    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import CSS -->
    <link rel="stylesheet" href="/css/material.min.css">
    <link rel="stylesheet" href="/css/style.min.css">
    <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }
</style>


<!-- Theme Background Related-->

    <style>
      body {
        /*background-color: #F5F5F5;*/
         background-image: url(https://api.i-meto.com/bing?color=white);
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text {
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>



    <script src="/js/jquery.min.js"></script>
    <script src="/js/queue.js"></script>

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    

    <!-- Bing Background -->
    
        <script type="text/javascript">
            queue.offer(function(){
                $('body').attr('data-original', 'https://api.i-meto.com/bing?color=white');
                $('body.lazy').lazyload();
            });
        </script>
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Isolation" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                
                    <!-- Isolation Header -->
                    <header class="header">
    <div class="header-wrapper">
        <!-- Header Copyright -->
        <div class="header-copyright">
            <div class="header-site">
                ©&nbsp;
                <script type="text/javascript">
                    var fd = new Date();
                    document.write(fd.getFullYear());
                </script>
                &nbsp;lennyup's Notes
            </div>
            <!--
            I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright.
            It will not impact the appearance and can give developers a lot of support :)

            很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
            它不会影响美观并可以给开发者很大的支持。 :)
            -->
            <div>
                Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a>
                <br>
                Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a>
            </div>
        </div>

        <!-- Header Title -->
        <span class="header-title header-item">
            <a href="/" title="lennyup&#39;s Notes">
                lennyup&#39;s Notes
            </a>
        </span>

        <p class="header-slogan header-item">
            所谓成功，就是不断的经历失败，并且始终保持热情。——丘吉尔
        </p>

        <!-- Header Nav -->
        <nav class="header-nav header-item">
            <span class="header-nav-item">
                <a href="/" title="Home">
                    <span>主页</span>
                </a>
            </span>

          <!-- Independent Pages -->
          
        </nav>

        <!-- Header SNS -->
        <div class="header-item header-sns_list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <i class="fa fa-twitter fa-lg" aria-hidden="true"></i>
        </a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <i class="fa fa-facebook fa-lg" aria-hidden="true"></i>
        </a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <i class="fa fa-google-plus fa-lg" aria-hidden="true"></i>
        </a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Telegram -->
    
</div>

    </div>
</header>

                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    

                    <!-- Post TOC -->

    



<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                


    <!-- Isolation Post Header -->
    <!-- Post thumbnail -->
    
        <!-- Post Header Info -->
        <div class="post-header_info without-thumbnail">
            <!-- Author Avatar & Name -->
            <img src="/img/avatar.png" class="avatar-img" width="44px" height="44px" alt="lennyup's avatar">
            <span class="name-span">lennyup</span>
        </div>

        <!-- Null Thumbnail -->
        <div class="post_thumbnail-null">
    
        </div>



                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    

    
        <div class="post-content_wrapper">
            <p class="post-title">
                Android 7.0 行为变更之FileProvider
            </p>
            <h3 id="一、简述"><a href="#一、简述" class="headerlink" title="一、简述"></a>一、简述</h3><p>之前在做拍照功能的时候，在7.0系统的手机上会出现问题，在看了看官网的<a href="https://developer.android.com/about/versions/nougat/android-7.0-changes.html" target="_blank" rel="external">Android 7.0行为变更</a>,才知道问题出在了哪里，适配的话必须去除项目中传递<code>file://</code>类似格式的uri了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">在7.0 以及以上的系统中，如果传递file:// 会触发FileUriExposedException异常</div></pre></td></tr></table></figure>
<p>在这里我仅把我遇到的问题以及解决办法说下，便于记录，没有什么技术含量的</p>
<p><img src="http://img.mp.itc.cn/upload/20170325/525cb4f28a4c426fb336116f810228e3.jpeg" alt=""></p>
<h3 id="二、拍照中的问题"><a href="#二、拍照中的问题" class="headerlink" title="二、拍照中的问题"></a>二、拍照中的问题</h3><p>拍照的代码我想大家都会熟悉，我们制定拍照的图片路径，intent传递一个uri给相机应用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">private static final int REQUEST_LAUNCH_IMAGE_LIBRARY = 13002;</div><div class="line"></div><div class="line">private Uri mCameraCaptureURI;</div><div class="line"></div><div class="line">public void launchCamera() &#123;</div><div class="line">	// 判断相机是否可用以及sd卡是否可用、相机权限是否开启</div><div class="line">	...</div><div class="line">	int requestCode = REQUEST_LAUNCH_IMAGE_LIBRARY;</div><div class="line">	Intent cameraIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);</div><div class="line">	String filename = new StringBuilder(&quot;image-&quot;).append(UUID.randomUUID().toString()).append(&quot;.jpg&quot;).toString();</div><div class="line">	File path = mContext.getExernalFilesDir(Environment.DIRECTORY_PICTURES)</div><div class="line">	File imageFile = new File(path, filename);</div><div class="line">        try &#123;</div><div class="line">            path.mkdirs();</div><div class="line">            imageFile.createNewFile();</div><div class="line">        &#125; catch (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">	mCameraCaptureURI = Uri.fromFile(imageFile);</div><div class="line">	cameraIntent.putExtra(MediaStore.EXTRA_OUTPUT, mCameraCaptureURI);</div><div class="line">        if (cameraIntent.resolveActivity(mActivity.getPackageManager()) == null) &#123;</div><div class="line">            showToast(&quot;无法调起相机&quot;);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        try &#123;</div><div class="line">            mActivity.startActivityForResult(cameraIntent, requestCode);</div><div class="line">        &#125; catch (ActivityNotFoundException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@Override</div><div class="line">    protected void onActivityResult(int requestCode, int resultCode, Intent data) &#123;</div><div class="line">        super.onActivityResult(requestCode, resultCode, data);</div><div class="line">        if (resultCode == RESULT_OK &amp;&amp; requestCode == REQUEST_LAUNCH_IMAGE_LIBRARY) &#123;</div><div class="line">			...</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><img src="http://d.hiphotos.baidu.com/zhidao/wh%3D450%2C600/sign=85d5e4568f94a4c20a76ef2f3bc437e3/e4dde71190ef76c6f4b2fe729516fdfaaf516702.jpg" alt="我不是效果图"></p>
<p>哈哈，我知道,没图你们是不会往下看的（ps： 效果图我不给你贴！ 滑稽）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Caused by: android.os.FileUriExposedException: </div><div class="line">    file:///storage/emulated/0/image-1085d49f-76f0-495f-8bdb-38b972299e00.jpg </div><div class="line">        exposed beyond app through ClipData.Item.getUri()</div><div class="line">    at android.os.StrictMode.onFileUriExposed(StrictMode.java:1932)</div><div class="line">    at android.net.Uri.checkFileUriExposed(Uri.java:2348)</div></pre></td></tr></table></figure>
<p>我的天，在7.0系统的手机上报错了，我去找原因！～</p>
<p>我们看下官网给出的解释：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">对于面向 Android 7.0 的应用，Android 框架执行的 StrictMode API 政策禁止在您的应用外部公开 file:// URI。如果一项包含文件 URI 的 intent 离开您的应用，则应用出现故障，并出现 FileUriExposedException 异常。</div><div class="line"></div><div class="line">要在应用间共享文件，您应发送一项 content:// URI，并授予 URI 临时访问权限。进行此授权的最简单方式是使用 FileProvider 类。如需了解有关权限和共享文件的详细信息，请参阅共享文件</div></pre></td></tr></table></figure>
<p><img src="http://img.tvmao.com/thumb/tvcolumn/0/409/360x270.jpg" alt=""></p>
<p>官网也给出了解决的办法，那就是用 <code>FileProvider</code>. 我们看下他的实现步骤</p>
<h3 id="使用FileProvider"><a href="#使用FileProvider" class="headerlink" title="使用FileProvider"></a>使用FileProvider</h3><p>在这里，对于<code>FileProvider</code>的使用，官网上给出了详细的步骤，有时间的话可以看下。<br><a href="https://developer.android.com/reference/android/support/v4/content/FileProvider.html" target="_blank" rel="external">FileProvider</a></p>
<h4 id="1-声明provider"><a href="#1-声明provider" class="headerlink" title="1.声明provider"></a>1.声明provider</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;provider</div><div class="line">            android:name=&quot;android.support.v4.content.FileProvider&quot;</div><div class="line">            android:authorities=&quot;$&#123;applicationId&#125;.provider&quot;</div><div class="line">            android:exported=&quot;false&quot;</div><div class="line">            android:grantUriPermissions=&quot;true&quot;&gt;</div><div class="line">            &lt;meta-data</div><div class="line">                android:name=&quot;android.support.FILE_PROVIDER_PATHS&quot;</div><div class="line">                android:resource=&quot;@xml/provider_path&quot; /&gt;</div><div class="line">        &lt;/provider&gt;</div></pre></td></tr></table></figure>
<p>FileProvider 是<code>ContentProvider</code>的子类， 所以需要声明一下下<br>meta-data里的 resource是自己写的xml文件。关于其中其他的配置在后面会讲道，莫急。</p>
<h4 id="2-编写xml"><a href="#2-编写xml" class="headerlink" title="2.编写xml"></a>2.编写xml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</div><div class="line">&lt;paths xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</div><div class="line">    &lt;external-path name=&quot;app_images&quot; path=&quot;.&quot;/&gt;</div><div class="line">&lt;/paths&gt;</div></pre></td></tr></table></figure>
<p>在<code>path</code>节点 支持以下几个字节点：</p>
<ul>
<li><code>&lt;root-path/&gt;</code> 代表设备的根目录<code>new File(&quot;/&quot;)</code>;</li>
<li><code>&lt;files-path/&gt;</code> 代表<code>context.getFilesDir()</code>;</li>
<li><code>&lt;cache-path/&gt;</code> 代表<code>context.getCacheDir()</code>;</li>
<li><code>&lt;external-path/&gt;</code> 代表<code>Environment.getExternalStorageDirectory()</code>;</li>
<li><code>&lt;external-files-path/&gt;</code>代表<code>context.getExternalFilesDirs()</code>;</li>
<li><code>&lt;external-cache-path/&gt;</code>代表<code>getExternalCacheDirs()</code>;</li>
</ul>
<p>每个节点支持两个属性：</p>
<ul>
<li><code>path</code> 需要临时授权访问的路径 . 代表所有路径</li>
<li><code>name</code> 就是你给这个路径起的名字</li>
</ul>
<p>我们所要做的是用 <code>content://uri</code>来替代<code>file://uri</code>,所以我们需要一个虚拟的路径进行映射，这就是我们要编写这个xml文件的原因。通过path确定访问目录，通过name映射真实的路径。</p>
<h4 id="使用-FileProvider"><a href="#使用-FileProvider" class="headerlink" title="使用 FileProvider"></a>使用 FileProvider</h4><p>这里我只贴一下核心的代码，其他的和之前写的是一样的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">// 之前</div><div class="line">mCameraCaptureURI = Uri.fromFile(imageFile);</div><div class="line">// 使用FileProvider</div><div class="line">final String packageName = context.getApplicationContext().getPackageName();</div><div class="line">            final String authority =  new StringBuilder(packageName).append(&quot;.provider&quot;).toString();</div><div class="line">            try</div><div class="line">            &#123;</div><div class="line">                mCameraCaptureURI = FileProvider.getUriForFile(context, authority, file);</div><div class="line">            &#125;</div><div class="line">            catch(IllegalArgumentException e)</div><div class="line">            &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>第二个参数就是我们之前在<code>AndroidManifest.xml</code>里配置的那个<code>authority</code></p>
<p>在此，可能会有疑问 为什么配置的时候</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">android:exported=&quot;false&quot;</div><div class="line">android:grantUriPermissions=&quot;true&quot;</div></pre></td></tr></table></figure>
<p>要这么写，<br>这里就要看下源码了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">public void attachInfo(Context context, ProviderInfo info) &#123;</div><div class="line">    super.attachInfo(context, info);</div><div class="line"></div><div class="line">    // Sanity check our security</div><div class="line">    if (info.exported) &#123;</div><div class="line">        throw new SecurityException(&quot;Provider must not be exported&quot;);</div><div class="line">    &#125;</div><div class="line">    if (!info.grantUriPermissions) &#123;</div><div class="line">        throw new SecurityException(&quot;Provider must grant uri permissions&quot;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mStrategy = getPathStrategy(context, info.authority);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>知道了吧，使用FileProvider之后我们在7.0的系统上拍照是没有问题了，那么是否可以做到兼容呢，我们在5.0 的手机上运行下，</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Caused by: java.lang.SecurityException: Permission Denial: opening provider android.support.v4.content.FileProvider from ProcessRecord&#123;52b029b8 1670:com.android.camera/u0a36&#125; (pid=1670, uid=10036) that is not exported from uid 10052</div><div class="line">at android.os.Parcel.readException(Parcel.java:1465)</div><div class="line">at android.os.Parcel.readException(Parcel.java:1419)</div><div class="line">at android.app.ActivityManagerProxy.getContentProvider(ActivityManagerNative.java:2848)</div><div class="line">at android.app.ActivityThread.acquireProvider(ActivityThread.java:4399)</div></pre></td></tr></table></figure>
<p>我的天， 又报错了，这次是<code>Permission Denial</code></p>
<p><img src="http://img4.imgtn.bdimg.com/it/u=4080811263,601276283&amp;fm=11&amp;gp=0.jpg" alt=""></p>
<p>通过万能的google了解到 需要给uri开通 读写的权限</p>
<h5 id="思路一"><a href="#思路一" class="headerlink" title="思路一"></a>思路一</h5><p>利用 <code>context. grantUriPermission</code> 对所有包都开启权限（ps：有时候并不晓得会选择哪个app）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">List&lt;ResolveInfo&gt; resInfoList = getPackageManager()</div><div class="line">               .queryIntentActivities(takePictureIntent, PackageManager.MATCH_DEFAULT_ONLY);</div><div class="line">       for (ResolveInfo resolveInfo : resInfoList) &#123;</div><div class="line">           String packageName = resolveInfo.activityInfo.packageName;</div><div class="line">           grantUriPermission(packageName, fileUri, Intent.FLAG_GRANT_READ_URI_PERMISSION</div><div class="line">                   | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</div><div class="line">       &#125;</div></pre></td></tr></table></figure>
<h5 id="思路二"><a href="#思路二" class="headerlink" title="思路二"></a>思路二</h5><p>上一个虽然可以解决，但是觉得有些麻烦，我可以根据系统的版本进行判断的呀</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</div><div class="line">    fileUri = FileProvider.getUriForFile(this, &quot;com.lenny.a7.provider&quot;, file);</div><div class="line">&#125; else &#123;</div><div class="line">    fileUri = Uri.fromFile(file);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="安装apk"><a href="#安装apk" class="headerlink" title="安装apk"></a>安装apk</h3><p>我们知道以前我们安装apk，是这么写的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">private void InstallAPK(String filePath)&#123;</div><div class="line">     Intent i = new Intent(Intent.ACTION_VIEW);</div><div class="line">     i.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">     i.setDataAndType(Uri.parse(&quot;file://&quot; + filePath),&quot;application/vnd.android.package-archive&quot;);</div><div class="line">     mContext.startActivity(i);</div><div class="line">     System.exit(0);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>在7.0系统以上的手机上又出现 <code>android.os.FileUriExposedException</code>异常。在上一个例子中，我们知道了如何处理：根据系统进行处理。可是这次出现了<br><code>Permission Denial</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ava.lang.SecurityException: Permission Denial: </div><div class="line">opening provider android.support.v4.content.FileProvider </div><div class="line">        from ProcessRecord&#123;18570a 27107:com.google.android.packageinstaller/u0a26&#125; (pid=27107, uid=10026) that is not exported from UID 10004</div></pre></td></tr></table></figure>
<p>我们可以在其加上上一个例子里的思路一的代码，加上权限。</p>
<p>通过与大神交流之后，知道原来还有一种方式可以搞定，那就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</div></pre></td></tr></table></figure>
<p>那么我们的解决办法也就可以这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public static Uri getUriFormFile(Context context, String filePath, Intent intent) &#123;</div><div class="line">    // 兼容7.0系统 uri file:// 的坑</div><div class="line">    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</div><div class="line">        File file = new File(filePath);</div><div class="line">        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</div><div class="line">        intent.addFlags(Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</div><div class="line">        final String packageName = context.getPackageName();</div><div class="line">        final String authority =  new StringBuilder(packageName).append(&quot;.provider&quot;).toString();</div><div class="line">        return FileProvider.getUriForFile(context, authority, file);</div><div class="line">    &#125; else &#123;</div><div class="line">        return Uri.parse(&quot;file://&quot; + filePath);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这时，你肯定要问为什么之前拍照的时候不用<code>addFlag</code>的方式呢？</p>
<p>哈哈，这位同学你的问题问的很到位呀。</p>
<p>因为addFlags主要用于setData，setDataAndType以及setClipData（注意：4.4时，并没有将ACTION_IMAGE_CAPTURE转为setClipData实现）这种方式。</p>
<p>所以addFlags方式对于ACTION_IMAGE_CAPTURE在5.0以下是无效的，所以需要使用grantUriPermission，如果是正常的通过setData分享的uri，使用addFlags是没有问题的（可以写个简单的例子测试下）</p>
<p>这时候，你又会问了，为什么拍照的时候没有设置就没有报错呢？</p>
<p>哈哈，这位同学你的问题好多呀。</p>
<p>拍照的时候， intent的action是<code>ACTION_IMAGE_CAPTURE</code>,startActivity后会调用 <code>intent.migrateExtraStreamToClipData();</code>方法。</p>
<p>在21之后，会有这段逻辑 (ps: 不要问我怎么知道的)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">if (MediaStore.ACTION_IMAGE_CAPTURE.equals(action)</div><div class="line">        || MediaStore.ACTION_IMAGE_CAPTURE_SECURE.equals(action)</div><div class="line">        || MediaStore.ACTION_VIDEO_CAPTURE.equals(action)) &#123;</div><div class="line">    final Uri output;</div><div class="line">    try &#123;</div><div class="line">        output = getParcelableExtra(MediaStore.EXTRA_OUTPUT);</div><div class="line">    &#125; catch (ClassCastException e) &#123;</div><div class="line">        return false;</div><div class="line">    &#125;</div><div class="line">    if (output != null) &#123;</div><div class="line">        setClipData(ClipData.newRawUri(&quot;&quot;, output));</div><div class="line">        addFlags(FLAG_GRANT_WRITE_URI_PERMISSION|FLAG_GRANT_READ_URI_PERMISSION);</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cameraIntent.putExtra(MediaStore.EXTRA_OUTPUT, mCameraCaptureURI);</div></pre></td></tr></table></figure>
<p>看到这里就会知道它会直接给我们添加权限。（在 21 之后）</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p> android 7.0 变更还有其他的变更，比如多窗口支持、屏幕缩放等。和我们关系最大的就是这个了。你可以将其写在一个工具类里面，有利于代码的优化，这里有鸿洋大神的例子<a href="https://github.com/hongyangAndroid/FitAndroid7" target="_blank" rel="external">FitAndroid7</a>可以学习一下</p>

        </div>
    
</div>


                
                    <!-- Paradox Post Info -->
                    
                

                <!-- Post Comments -->
                
                    
    <!-- 使用多说评论 -->
    <link rel="stylesheet" href="/css/duoshuo.min.css">
<style>
    #ds-thread #ds-reset .ds-post-button{
        background-color: #0097A7 !important;
    }
    #ds-wrapper #ds-reset .ds-icons-32{
        background-color: #0097A7 !important;
    }
    #ds-reset .ds-highlight {
        color: #0097A7 !important;
    }
</style>
<div id="comments">
    <!-- 多说评论框 start -->
    <div class="ds-thread"
        data-thread-key="2017/06/09/file-provider/"
        data-url="https://lennyup.github.io/2017/06/09/file-provider/"
        data-title="Android 7.0 行为变更之FileProvider" id="ds-thread">
    </div>
    <!-- 多说评论框 end -->
</div>






                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/09/15/rn-native/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/05/05/eventbus-first/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
</footer>


                    <!-- Import File -->
<script src="/js/lazyload.min.js"></script>
<script src="/js/js.min.js"></script>
<script src="/js/nprogress.js"></script>

<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>





    <!-- Leancloud -->
    <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
    <script>
        AV.initialize('WPJ4R6qYeJQjJl3KmMAJoME0-gzGzoHsz', 'iRC9fkt9xkx9KoqFepPypBJP');
    </script>
    <script>
    function showTime(Counter) {
        var query = new AV.Query(Counter);
        $('.leancloud-views_num').each(function() {
            var url = $(this).attr('id').trim();
            query.equalTo('url', url);
            query.find({
                success: function(results) {
                    if (results.length === 0) {
                        var content = '0 ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                        return;
                    }
                    for (var i = 0; i < results.length; i++) {
                        var object = results[i];
                        var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    }
                },
                error: function(object, error) {
                    console.log('Error: ' + error.code + ' ' + error.message);
                }
            });
        });
    }

    function addCount(Counter) {
      var Counter = AV.Object.extend('Counter');
      url = $('.leancloud-views_num').attr('id').trim();
      title = $('.leancloud-views_num').attr('data-flag-title').trim();
      var query = new AV.Query(Counter);
      query.equalTo('url', url);
      query.find({
          success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment('time');
                counter.save(null, {
                    success: function(counter) {
                        var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
                        $(document.getElementById(url)).text(content);
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
              var newcounter = new Counter();
              newcounter.set('title', title);
              newcounter.set('url', url);
              newcounter.set('time', 1);
              newcounter.save(null, {
                  success: function(newcounter) {
                      console.log('newcounter.get(\'time\')='+newcounter.get('time'));
                      var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
                      $(document.getElementById(url)).text(content);
                  },
                  error: function(newcounter, error) {
                      console.log('Failed to create');
                  }
              });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + ' ' + error.message);
        }
      });
    }
    $(function() {
        var Counter = AV.Object.extend('Counter');
        if ($('.leancloud-views_num').length === 1) {
            addCount(Counter);
        } else if ($('.post-title-link').length > 1) {
            showTime(Counter);
        }
    });
</script>




    <!-- Busuanzi -->
    <script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    <!-- 多说公共 js 代码 start -->
    <script type="text/javascript">
        queue.offer(function(){
            window.duoshuoQuery = {
                short_name: 'lennyupio'
            };
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';
                ds.async = true;
                ds.src = 'https://static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                 || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        });
    </script>
    <!-- 多说公共 js 代码 end -->





<!-- Swiftye -->


<!-- Local Search-->


<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->


                </main>
            </div>
        </body>
    
</html>
